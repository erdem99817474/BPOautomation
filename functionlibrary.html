<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RPA自動化 — 電通データアーティストモンゴル</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { color-scheme: light; }
    .container { max-width: 1200px; }
    /* narrow preview cells */
    .cell-narrow {
      max-width: 240px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cell-narrow.code { max-width: 200px; }
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-white text-gray-900 min-h-screen">
  <!-- Top bar -->
  <header class="bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold tracking-tight flex items-center gap-2">
        <span class="inline-block h-2.5 w-2.5 rounded-full bg-gradient-to-br from-fuchsia-500 to-sky-500"></span>
        Functions Library
      </h1>
      <nav class="text-sm text-gray-500">Auto-loaded from Google Sheets</nav>
    </div>
    <div class="h-1 bg-gradient-to-r from-fuchsia-200 via-sky-200 to-violet-200"></div>
  </header>

  <main class="container mx-auto p-4 space-y-6">
    <!-- Toolbar -->
    <section class="bg-white border border-gray-200 rounded-2xl p-4 shadow-sm">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:gap-4">
        <div class="flex-1">
          <label class="block text-xs font-medium mb-1 text-gray-700">Search (Step_ID / Section / Description) — current sheet</label>
          <div class="relative">
            <svg aria-hidden="true" viewBox="0 0 24 24" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"><path d="M10 4a6 6 0 1 1 3.997 10.392l3.806 3.807a1 1 0 0 1-1.414 1.414l-3.807-3.806A6 6 0 0 1 10 4Zm0 2a4 4 0 1 0 .001 8.001A4 4 0 0 0 10 6Z" /></svg>
            <input id="searchBox" type="text"
              class="w-full border border-gray-200 rounded-xl pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-fuchsia-500 focus:border-fuchsia-500 placeholder:text-gray-400 transition"
              placeholder="Type to filter… (partial text OK)">
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="status" class="text-xs text-gray-600 px-2 py-1 rounded-md bg-gray-50 border border-gray-200">Loading…</div>
          <button id="openPreviewBtn" class="px-3 py-2 rounded-xl text-xs text-white bg-gradient-to-r from-amber-500 to-pink-500 hover:from-amber-600 hover:to-pink-600 shadow-sm transition">
            Open Preview
          </button>
          <button id="refreshBtn" class="px-3 py-2 rounded-xl border border-gray-200 text-xs bg-white hover:bg-gray-50 active:scale-[.99] transition">Refresh</button>
        </div>
      </div>
      <!-- Tabs under toolbar -->
      <div id="sheetTabs" class="mt-4 flex flex-wrap gap-2"></div>
    </section>

    <!-- Functions list -->
    <section id="listSection" class="space-y-3"></section>

    <!-- Preview (full) -->
    <section id="previewSection" class="border border-gray-200 rounded-2xl p-4 bg-white shadow-sm">
      <div class="text-sm font-medium mb-2 flex items-center gap-2">
        <span class="inline-block h-2.5 w-2.5 rounded-full bg-gradient-to-br from-fuchsia-500 to-sky-500"></span>
        Preview (all rows of active sheet)
      </div>
      <div class="overflow-auto border border-gray-200 rounded-xl">
        <table class="min-w-full text-sm">
          <thead id="tableHead" class="bg-gray-50 sticky top-0 z-10"></thead>
          <tbody id="tableBody" class="[&>tr:nth-child(even)]:bg-gray-50/50"></tbody>
        </table>
      </div>
      <p class="mt-2 text-[11px] text-gray-500">If auto-discovery fails: 1) In Google Sheets: <em>File → Share → Publish to web → Entire document</em>; OR 2) Create a tab named <code>Index</code> with a column <code>Sheet</code>/<code>シート</code>/<code>Tab</code> listing tab names to include. Click <strong>Refresh</strong> after changes.</p>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const SHEET_ID = "1zLx-1OSUnytTQPK4CQDssSAc2Nt7UrUZOjOBGHDW7H4";
    const INDEX_SHEET = "Index";

    // ===== CACHE-BUST + STATE RESET =====
    let CACHE_BUST = ""; // set when pressing Refresh to bypass caches
    function resetState(){
      state = { dataByTab:{}, _rawByTab:{}, tabOrder:[], active:null, firstPreviewDone:false, _baseRows:[] };
      previewRenderToken++; // cancel any in-flight preview rendering
      const tabs = $("sheetTabs"); if(tabs) tabs.innerHTML = '';
      const list = $("listSection"); if(list) list.innerHTML = '';
      const th = $("tableHead"); if(th) th.innerHTML = '';
      const tb = $("tableBody"); if(tb) tb.innerHTML = '';
    }

    // ===== HELPERS =====
    const $ = (id)=> document.getElementById(id);
    const make = (tag, cls, html)=> { const el=document.createElement(tag); if(cls) el.className=cls; if(html!==undefined) el.innerHTML=html; return el; };
    const csvUrl = (sheetName)=> {
      const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
      return CACHE_BUST ? `${base}&cb=${CACHE_BUST}` : base;
    };
    const sanitizeHtmlLite = (str)=> String(str||""); // allow scripts in iframe previews

    // ===== UI RENDER =====
    // Incremental rendering for performance
    let previewRenderToken = 0;
    function renderPreview(headers, rows){
      const myToken = ++previewRenderToken;            // cancel previous renders
      $("tableHead").innerHTML = '';
      $("tableBody").innerHTML = '';

      // Header
      const trh = make('tr');
      headers.forEach(h=> trh.appendChild(make('th','px-3 py-2 text-left font-semibold text-gray-700', h)) );
      $("tableHead").appendChild(trh);

      // Body in chunks
      const tbody = $("tableBody");
      const BATCH = 150; // tweak for speed vs. smoothness
      let i = 0;

      function renderChunk(){
        if (myToken !== previewRenderToken) return; // aborted
        const end = Math.min(i + BATCH, rows.length);
        for(let r=i; r<end; r++){
          const tr = document.createElement('tr');
          tr.className = 'border-t border-gray-100 hover:bg-sky-50/40 transition-colors';
          const row = rows[r];
          for(const h of headers){
            const td = document.createElement('td');
            const isCode = /^(script|code)$/i.test(h);
            td.className = `px-3 py-1 align-top text-gray-800 cell-narrow${isCode ? ' code' : ''}`;
            const v = row[h] ?? '';
            td.title = String(v); // tooltip with full value
            td.textContent = v;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        i = end;
        if(i < rows.length) requestAnimationFrame(renderChunk);
      }

      requestAnimationFrame(renderChunk);
    }

    // Section-first card layout with Option1/Option2 badges
    function functionCard({ step, section, opt1, opt2, desc, code, imageHtml }){
      const card = make('div','border border-gray-200 rounded-2xl p-4 bg-white shadow-sm hover:shadow-md hover:-translate-y-[1px] transition-all duration-300');
      card.appendChild(make('div','flex items-start justify-between gap-3', `
        <div class="min-w-0">
          <div class="inline-flex items-center gap-2 mb-1">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gradient-to-br from-fuchsia-50 to-sky-50 text-fuchsia-700 border border-fuchsia-100">${section || '—'}</span>
            ${opt1 ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gradient-to-br from-sky-50 to-violet-50 text-sky-700 border border-sky-100">${opt1}</span>` : ''}
            ${opt2 ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium bg-gradient-to-br from-amber-50 to-pink-50 text-amber-700 border border-amber-100">${opt2}</span>` : ''}
          </div>
          <h3 class="text-base font-semibold text-gray-900 truncate">${step || '(No Step_ID)'}</h3>
        </div>
      `));

      const actions = make('div','mt-3 flex flex-wrap gap-2');
      const b1 = make('button','px-3 py-1.5 rounded-xl border border-gray-200 text-gray-800 hover:bg-gray-50 transition','説明');
      const b2 = make('button','px-3 py-1.5 rounded-xl border border-gray-200 text-gray-800 hover:bg-gray-50 transition','Code');
      const b3 = make('button','px-3 py-1.5 rounded-xl text-white bg-gradient-to-r from-fuchsia-600 to-sky-600 hover:from-fuchsia-700 hover:to-sky-700 shadow-sm transition','Preview');
      actions.append(b1,b2,b3);
      card.appendChild(actions);

      const panel = make('div','mt-3'); card.appendChild(panel);

      b1.onclick = ()=>{
        panel.innerHTML='';
        panel.appendChild(make('div','text-sm text-gray-800 whitespace-pre-wrap bg-gray-50/70 border border-gray-200 rounded-xl p-3', desc || '(no Description)'));
      };

      b2.onclick = ()=>{
        panel.innerHTML='';
        const wrap=make('div','space-y-2');
        const cpy=make('button','px-3 py-1.5 rounded-xl text-white bg-gradient-to-r from-indigo-600 to-sky-600 hover:from-indigo-700 hover:to-sky-700 shadow-sm transition','Copy code');
        const pre=make('pre','bg-gray-900 text-gray-50 text-xs rounded-xl p-3 overflow-auto');
        pre.textContent = code || '';
        cpy.onclick=async()=>{
          try{ await navigator.clipboard.writeText(code||''); cpy.textContent='Copied!'; setTimeout(()=>cpy.textContent='Copy code',1200);}
          catch{ alert('Copy failed'); }
        };
        wrap.append(cpy,pre);
        panel.appendChild(wrap);
      };

      b3.onclick = ()=>{
        panel.innerHTML='';
        const iframe=make('iframe','w-full rounded-xl border border-gray-200 min-h-[260px] bg-white');
        iframe.sandbox = 'allow-scripts allow-forms allow-popups';
        iframe.srcdoc = imageHtml || '<div style="padding:16px;font:14px system-ui;color:#444">(No 画像 HTML)</div>';
        panel.appendChild(iframe);
      };

      b1.click();
      return card;
    }

    function renderList(rows){
      const wrap = $("listSection"); wrap.innerHTML='';
      rows.forEach(r=> wrap.appendChild(functionCard(r)) );
    }

    function renderTabs(active){
      const tabs = $("sheetTabs"); tabs.innerHTML='';
      state.tabOrder.forEach(name=>{
        const isActive = name===active;
        const btn = make('button',
          `px-3 py-1.5 rounded-full border text-sm transition-all duration-300
           ${isActive
              ? 'text-white bg-gradient-to-r from-fuchsia-600 to-sky-600 border-transparent shadow-sm'
              : 'border-gray-200 text-gray-800 hover:bg-gray-50'}`,
          name
        );
        btn.onclick=()=> selectSheet(name);
        tabs.appendChild(btn);
      });
    }

    // ===== DATA + CACHING =====
    let state = { dataByTab:{}, _rawByTab:{}, tabOrder:[], active:null, firstPreviewDone:false, _baseRows:[] };
    const TTL = 6 * 60 * 60 * 1000;
    const KEY_PREFIX = `gs:${SHEET_ID}:`;
    const cacheGet = (k)=>{ try{ const raw=localStorage.getItem(KEY_PREFIX+k); if(!raw) return null; const o=JSON.parse(raw); if(Date.now()-o.t>TTL) return null; return o.v; }catch{ return null; } };
    const cacheSet = (k,v)=>{ try{ localStorage.setItem(KEY_PREFIX+k, JSON.stringify({t:Date.now(), v})); }catch{} };
    const cacheClear = ()=>{ try{ Object.keys(localStorage).filter(k=>k.startsWith(KEY_PREFIX)).forEach(k=>localStorage.removeItem(k)); }catch{} };

  // INDEX-only, no early return from local cache, robust row-2+ parsing
async function fetchTitles(){
  // Always fetch fresh (uses CACHE_BUST via csvUrl)
  const res = await fetch(csvUrl(INDEX_SHEET), { cache: 'no-store' });
  if (!res.ok) throw new Error('INDEX_NOT_FOUND');

  const text = await res.text();

  // Parse as raw rows (no headers) to avoid header/BOM issues
  const parsed = await new Promise(resolve =>
    Papa.parse(text, {
      header: false,
      skipEmptyLines: 'greedy',
      complete: r => resolve(r)
    })
  );

  const rows = parsed.data || [];
  if (!rows.length) throw new Error('INDEX_EMPTY_SHEET');

  // Helper
  const norm = s => String(s ?? '').replace(/^\uFEFF/, '').trim();

  // Find target column:
  // - if you want to force a column, set const FORCE_INDEX_COL = 0|1|2...
  // - else auto-pick first column that has ANY non-empty cell after row 1
  const FORCE_INDEX_COL = null;  // <- set to 0 for column A, 1 for B, etc.
  let colIdx = (typeof FORCE_INDEX_COL === 'number') ? FORCE_INDEX_COL : -1;

  if (colIdx < 0) {
    const width = Math.max(...rows.map(r => r.length));
    for (let c = 0; c < width; c++) {
      if (rows.slice(1).some(r => norm(r[c]).length > 0)) { colIdx = c; break; }
    }
  }
  if (colIdx < 0) throw new Error('INDEX_NO_USABLE_COLUMN');

  // Collect names from row 2..N (skip header row)
  const names = rows
    .slice(1)
    .map(r => norm(r[colIdx]))
    .filter(v => v.length > 0);

  if (!names.length) throw new Error('INDEX_ONLY_HEADER_NO_ROWS');

  // Update cache (optional) — but DO NOT early-return from cache next time
  cacheSet('titles', names);

  // Helpful for quick verification in DevTools
  console.log('[Index] using column', String.fromCharCode(65 + colIdx), 'names:', names);

  return names;
}



    async function loadTab(name){
      const cachedMapped = cacheGet('tab:'+name);
      if (cachedMapped) {
        // Ensure RAW rows exist even when we return cached mapped rows
        if (!state._rawByTab[name] || CACHE_BUST) {
          try {
            const res = await fetch(csvUrl(name), { cache: 'no-store' });
            if (res.ok) {
              const text = await res.text();
              const rawRows = await new Promise(resolve =>
                Papa.parse(text, { header:true, skipEmptyLines:true, complete: r => resolve(r.data) })
              );
              state._rawByTab[name] = rawRows;
              if (state.active === name) {
                const headers = Array.from(new Set(rawRows.flatMap(r => Object.keys(r || {}))));
                renderPreview(headers, rawRows);
              }
              // If we are cache-busting, also remap + recache mapped rows
              if (CACHE_BUST) {
                const remapped = mapColumns(rawRows);
                cacheSet('tab:'+name, remapped);
                return remapped;
              }
            }
          } catch(_) {}
        }
        return cachedMapped;
      }

      // No cached mapped rows: fetch fresh
      const res = await fetch(csvUrl(name), { cache: 'no-store' });
      if(!res.ok) throw new Error('Fetch failed for '+name);
      const text = await res.text();
      const rawRows = await new Promise(resolve =>
        Papa.parse(text, { header:true, skipEmptyLines:true, complete: r => resolve(r.data) })
      );
      state._rawByTab[name] = rawRows;
      const mapped = mapColumns(rawRows);
      cacheSet('tab:'+name, mapped);
      return mapped;
    }

    // Flexible mapping: defaults to Step_ID / Section / Description, supports JP too + Option1/Option2
    function mapColumns(rows){
      if(!rows || !rows.length) return [];
      const norm = (s)=> String(s||'').trim().toLowerCase();

      const first = rows[0] || {};
      const keys = Object.keys(first);
      const m = {};
      keys.forEach(k=>{
        const n = norm(k);
        if(n==='step_id' || n==='step id' || n==='step' || n==='ステップ') m.step = k;                   // Step_ID
        else if(n==='section' || n==='セクション') m.section = k;                                        // Section
        else if(n==='description' || n==='説明') m.desc = k;                                            // Description
        else if(n==='script' || n==='code') m.code = k;                                                 // Script/Code
        else if(n==='image' || n==='画像' || n==='html') m.image = k;                                   // 画像/HTML
        else if(n==='option1' || n==='オプション1' || n==='option 1') m.opt1 = k;                        // Option1
        else if(n==='option2' || n==='オプション2' || n==='option 2') m.opt2 = k;                        // Option2
      });

      return rows
        .filter(r=> (r[m.step]||r[m.section]||r[m.desc]||r[m.code]||r[m.image]||r[m.opt1]||r[m.opt2]))
        .map(r=> ({
          step: r[m.step] || '',
          section: r[m.section] || '',
          opt1: r[m.opt1] || '',
          opt2: r[m.opt2] || '',
          desc: r[m.desc] || '',
          code: r[m.code] || '',
          imageHtml: r[m.image] || ''
        }));
    }

    // ===== SEARCH (active sheet only) =====
    function applySearchAndRender(){
      const qEl = document.getElementById('searchBox');
      const q = (qEl && qEl.value || '').toString().trim().toLowerCase();
      const base = (state && state._baseRows) || [];
      if(!q){ renderList(base); updateCount(base.length); return; }
      const filtered = base.filter(r=>{
        const a = (r.step||'').toString().toLowerCase();       // Step_ID
        const b = (r.section||'').toString().toLowerCase();    // Section
        const c = (r.desc||'').toString().toLowerCase();       // Description
        return a.includes(q) || b.includes(q) || c.includes(q);
      });
      renderList(filtered); updateCount(filtered.length);
    }
    function updateCount(n){
      const st = document.getElementById('status');
      if(st && state && state.active){ st.textContent = `Showing: ${state.active} (${n} items)`; }
    }

    // ===== BOOTSTRAP =====
    async function start(){
      $("status").textContent = 'Loading sheets…';
      let titles = [];
      try { titles = await fetchTitles(); }
      catch(e){ $("status").textContent = `Couldn't auto-discover tabs. Do one of: 1) Publish to web (Entire document), or 2) Create an "${INDEX_SHEET}" tab listing names in a column: Sheet/シート/Tab. Then click Refresh.`; return; }
      state.tabOrder = titles;
      if(!titles.length){ $("status").textContent = 'No sheets found.'; return; }
      renderTabs(titles[0]);
      selectSheet(titles[0]);
      titles.slice(1).forEach(async t=>{ try{ state.dataByTab[t] = await loadTab(t); }catch{} });
    }

    async function selectSheet(name){
      state.active = name;
      renderTabs(name);
      $("status").textContent = `Loading: ${name}…`;
      try{
        // If we're cache-busting, ignore in-memory copy to force re-fetch
        if (CACHE_BUST) delete state.dataByTab[name];

        const rows = state.dataByTab[name] || await loadTab(name);
        state.dataByTab[name] = rows;
        state._baseRows = rows;           // for search
        applySearchAndRender();            // cards

        // preview (ALL rows) — incremental
        if (!state._rawByTab[name]) {
          await loadTab(name); // ensures raw rows are present after cache-bust
        }
        const raw = state._rawByTab[name] || [];
        if(raw.length){
          const headers = Array.from(new Set(raw.flatMap(r => Object.keys(r || {}))));
          renderPreview(headers, raw);
        }else{
          $("tableHead").innerHTML = '';
          $("tableBody").innerHTML = '<tr><td class="px-3 py-2 text-gray-500">No rows.</td></tr>';
        }
        updateCount(rows.length);
      }catch(e){
        $("listSection").innerHTML = '<div class="text-sm text-red-600">Failed to load this sheet.</div>';
        $("status").textContent = `Failed to load: ${name}`;
      }
    }

    // Buttons
    document.getElementById('refreshBtn').addEventListener('click', ()=>{
      try{ const KEY_PREFIX = `gs:${SHEET_ID}:`; Object.keys(localStorage).filter(k=>k.startsWith(KEY_PREFIX)).forEach(k=>localStorage.removeItem(k)); }catch{}
      CACHE_BUST = String(Date.now()); // force fresh network responses
      resetState();
      start();
    });
    document.getElementById('openPreviewBtn').addEventListener('click', ()=>{
      const el = document.getElementById('previewSection');
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // Debounced search
    const searchInput = document.getElementById('searchBox');
    let __searchTimer = null;
    if(searchInput){
      searchInput.addEventListener('input', ()=>{
        if(__searchTimer) clearTimeout(__searchTimer);
        __searchTimer = setTimeout(applySearchAndRender, 150);
      });
    }
    window.addEventListener('load', start);
  </script>
</body>
</html>
